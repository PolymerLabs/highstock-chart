<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../yql-data/yql-data.html">

<!--
A data source element for Yahoo Finance historical data. To be used only within a <highstock-chart> element.

##### Example

    <highstock-chart>
      <highstock-chart-data
        symbol="AAPL"
        startdate="2010-01-01"
        enddate="2010-12-31"></highstock-chart-data>
    </highstock-chart>

@element highstock-chart-data
@blurb A data source element for Yahoo Finance historical data. To be used only within a <highstock-chart> element.
@homepage https://polymerlabs.github.io/highstock-chart/
-->
<polymer-element name="highstock-chart-data" attributes="symbol startdate enddate">
  <template>
    <template repeat="{{query in queries}}">
      <yql-data query="{{query}}" on-core-response="{{handleResponse}}"></yql-data>
    </template>
  </template>

  <script>
    Polymer({
      /**
       * The stock symbol.
       *
       * @attribute symbol
       * @type string
       */
      symbol: null,

      /**
       * The start date in YYYY-MM-DD format.
       *
       * @attribute startdate
       * @type string
       */
      startdate: null,

      /**
       * The end date in YYYY-MM-DD format.
       *
       * @attribute enddate
       * @type string
       */
      enddate: null,

      /**
       * The HighStock chart series associated with this data source.
       *
       * @attribute series
       * @type Highcharts.Series
       */
      series: null,

      /**
       * The list of YQL queries.
       *
       * @attribute queries
       * @type Array.<string>
       */
      queries: null,

      ready: function() {
        this.series = this.parentElement.chart.addSeries({});
        this.reset_();
      },

      attributeChanged: function() {
        this.reset_();
      },

      reset_: function() {
        this.queries = [];
        this.series.name = this.symbol;
        this.series.setData(null);
        this.buildQueries_();
      },

      buildQueries_: function() {
        this.queries = [];

        // Since YQL will only respond if the query results in less than 365 data points,
        // we seperate each calendar year to its own request.
        var start = new Date(this.startdate);
        var end = new Date(this.enddate);
        var startYear = start.getUTCFullYear();
        var endYear = end.getUTCFullYear();

        if (startYear === endYear) {
          this.addQuery_(this.startdate, this.enddate);
        } else {
          this.addQuery_(endYear + '-01-01', this.enddate);
          --endYear;

          while (endYear > startYear) {
            this.addQuery_(endYear + '-01-01', endYear + '-12-31');
            --endYear;
          }
          
          this.addQuery_(this.startdate, startYear + '-12-31');
        }
      },

      addQuery_: function(startdate, enddate) {
        var query = "SELECT * FROM yahoo.finance.historicaldata WHERE symbol = '" +
          this.symbol + "' and startDate = '" + startdate + "' and endDate = '" +
          enddate + "'";
        this.queries.push(query);
      },

      handleResponse: function(evt, details) {
        var results = details.response.query.results;

        if (results) {
          // For performance, redraw only after all points have been added to the series.
          this.getData_(results).forEach(function(point) {
            this.series.addPoint(point, false /* redraw */);
          }.bind(this));
          this.parentElement.chart.redraw();
        }
      },

      getData_: function(results) {
        // The response from <yql-data> comes in reverse-chronological order, so reverse it.
        var quote = results.quote.reverse();

        // Highcharts expects data points to be an array of [timestamp, value] points.
        return quote.map(function(q){
          var timestamp = (new Date(q['Date'])).valueOf();
          var value = parseFloat(q['Adj_Close']);
          return [timestamp, value];
        });
      }
    });
  </script>
</polymer-element>
